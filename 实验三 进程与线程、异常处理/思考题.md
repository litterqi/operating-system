## 思考题1：阅读vmspace的数据结构
vmspace.h位于lab3\kernel\include\mm中
### struct vmregion
这段代码定义了一个名为 vmregion 的结构体，它在操作系统中通常用于表示虚拟内存区域。

`struct list_head node;`：这是一个链表节点，用于将vmregion结构体链接到其他的vmregion结构体，形成一个链表。这在操作系统中常常用于管理一系列的内存区域。

`vaddr_t start;`：这是虚拟内存区域的起始地址。vaddr_t是一个类型定义，通常表示虚拟地址。

`size_t size;`：这是虚拟内存区域的大小，通常以字节为单位。

`vmr_prop_t perm;`：这是虚拟内存区域的权限，例如读、写、执行等。vmr_prop_t是一个类型定义，通常用于表示权限。

`struct pmobject *pmo;`：这是一个指向pmobject结构体的指针。pmobject结构体通常用于表示物理内存对象，例如一个文件或者一个内存页。
### struct vmspace
这段代码定义了一个名为vmspace的结构体，它在操作系统中通常用于表示一个进程的虚拟内存空间。

`struct list_head vmr_list;`：这是一个链表头，用于链接vmregion结构体，形成一个链表。这在操作系统中常常用于管理一系列的虚拟内存区域。

`void *pgtbl;`：这是一个指向页表的指针。页表是一种数据结构，用于实现虚拟地址到物理地址的映射。

`u64 pcid;`：这是一个64位无符号整数，通常用于表示进程上下文标识符（PCID）。PCID是一种硬件特性，用于减少在进程切换时TLB（转换后援缓冲器）的无效化开销。

`struct vmregion *heap_vmr;`：这是一个指向 vmregion 结构体的指针，通常用于表示进程的堆。堆是进程用于动态内存分配的区域。

`vaddr_t user_current_heap;`：这是当前堆的虚拟地址。vaddr_t 是一个类型定义，通常表示虚拟地址。

`vaddr_t user_current_mmap_addr;`：这是当前映射（mmap）的虚拟地址。映射是一种将文件或者其他对象映射到进程的虚拟地址空间的机制。
### struct pmobject
这段代码定义了一个名为pmobject的结构体，它在操作系统中通常用于表示一个物理内存对象。

`struct radix *radix;`：这是一个指向基数树的指针。基数树是一种数据结构，通常用于存储和查找物理页。

`paddr_t start;`：这是物理内存对象的起始地址。paddr_t是一个类型定义，通常表示物理地址。

`size_t size;`：这是物理内存对象的大小，通常以字节为单位。

`pmo_type_t type;`：这是物理内存对象的类型。pmo_type_t是一个类型定义，可能包含各种不同的物理内存对象类型，例如文件、内存页等。
### struct cap_group
定义cap_group结构体，作为进程的抽象。
### 宏定义
```
typedef u64 pmo_type_t;
#define PMO_ANONYM       0 /* lazy allocation */
#define PMO_DATA         1 /* immediate allocation */
#define PMO_SHM          3 /* shared memory */
#define PMO_DEVICE       5 /* memory mapped device registers */
#define PMO_DATA_NOCACHE 6 /* non-cacheable immediate allocation */

#define PMO_FORBID 10 /* Forbidden area: avoid overflow */
```
`typedef u64 pmo_type_t;`：这是一个类型定义，将 u64（一个64位无符号整数类型）定义为 pmo_type_t。这意味着你可以使用 pmo_type_t 来声明一个64位无符号整数。

`#define PMO_ANONYM 0`等：这些是预处理器宏定义，它们为不同类型的物理内存对象（Physical Memory Object）定义了常量。这些常量可以在代码中用于区分不同类型的物理内存对象。具体来说：

`PMO_ANONYM`表示匿名内存对象，通常用于延迟分配内存。

`PMO_DATA`表示数据内存对象，通常用于立即分配内存。

`PMO_SHM`表示共享内存对象。

`PMO_DEVICE`表示设备内存对象，通常用于内存映射设备寄存器。

`PMO_DATA_NOCACHE`表示非缓存的数据内存对象，用于立即分配非缓存内存。

`PMO_FORBID`表示禁止区域，用于避免溢出。
### 函数定义
```
int create_pmo(u64 size, u64 type, struct cap_group *cap_group,
               struct pmobject **new_pmo);

int vmspace_init(struct vmspace *vmspace);

int vmspace_map_range(struct vmspace *vmspace, vaddr_t va, size_t len,
                      vmr_prop_t flags, struct pmobject *pmo);
int vmspace_unmap_range(struct vmspace *vmspace, vaddr_t va, size_t len);
int unmap_pmo_in_vmspace(struct vmspace *vmspace, struct pmobject *pmo);

struct vmregion *find_vmr_for_va(struct vmspace *vmspace, vaddr_t addr);

void switch_vmspace_to(struct vmspace *);

void commit_page_to_pmo(struct pmobject *pmo, u64 index, paddr_t pa);
paddr_t get_page_from_pmo(struct pmobject *pmo, u64 index);

struct vmregion *init_heap_vmr(struct vmspace *vmspace, vaddr_t va,
                               struct pmobject *pmo);

void kprint_vmr(struct vmspace *vmspace);
```
`int create_pmo(u64 size, u64 type, struct cap_group *cap_group, struct pmobject **new_pmo);`：这个函数用于创建一个新的物理内存对象（pmo）。它接受物理内存对象的大小、类型、权限组和一个指向新物理内存对象的指针的指针作为参数。

`int vmspace_init(struct vmspace *vmspace);`：这个函数用于初始化一个虚拟内存空间。它接受一个指向虚拟内存空间的指针作为参数。

`int vmspace_map_range(struct vmspace *vmspace, vaddr_t va, size_t len, vmr_prop_t flags, struct pmobject *pmo);`：这个函数用于将一个物理内存对象映射到虚拟内存空间的一个范围。它接受一个指向虚拟内存空间的指针、虚拟地址、长度、标志和一个指向物理内存对象的指针作为参数。

`int vmspace_unmap_range(struct vmspace *vmspace, vaddr_t va, size_t len);`：这个函数用于从虚拟内存空间中取消映射一个范围。它接受一个指向虚拟内存空间的指针、虚拟地址和长度作为参数。

`int unmap_pmo_in_vmspace(struct vmspace *vmspace, struct pmobject *pmo);`：这个函数用于从虚拟内存空间中取消映射一个物理内存对象。它接受一个指向虚拟内存空间的指针和一个指向物理内存对象的指针作为参数。

`struct vmregion *find_vmr_for_va(struct vmspace *vmspace, vaddr_t addr);`：这个函数用于在虚拟内存空间中查找一个虚拟地址对应的虚拟内存区域。它接受一个指向虚拟内存空间的指针和一个虚拟地址作为参数。

`void switch_vmspace_to(struct vmspace *);`：这个函数用于切换到一个新的虚拟内存空间。它接受一个指向虚拟内存空间的指针作为参数。

`void commit_page_to_pmo(struct pmobject *pmo, u64 index, paddr_t pa);`：这个函数用于将一个物理页提交到一个物理内存对象。它接受一个指向物理内存对象的指针、一个索引和一个物理地址作为参数。

`paddr_t get_page_from_pmo(struct pmobject *pmo, u64 index);`：这个函数用于从一个物理内存对象中获取一个物理页。它接受一个指向物理内存对象的指针和一个索引作为参数。

`struct vmregion *init_heap_vmr(struct vmspace *vmspace, vaddr_t va, struct pmobject *pmo);`：这个函数用于初始化一个堆虚拟内存区域。它接受一个指向虚拟内存空间的指针、一个虚拟地址和一个指向物理内存对象的指针作为参数。

`void kprint_vmr(struct vmspace *vmspace);`：这个函数用于打印虚拟内存空间的信息。它接受一个指向虚拟内存空间的指针作为参数。
## 思考题2：描述如何切换到根线程
在创建根线程之后，操作系统通常会通过以下步骤切换到根线程中：

保存当前上下文：操作系统首先会保存当前正在运行的线程的上下文。上下文包括程序计数器、寄存器的值、堆栈指针等。

设置新的上下文：然后，操作系统会设置新的上下文，即根线程的上下文。这包括设置程序计数器为根线程的入口点，设置堆栈指针为根线程的堆栈等等。

执行上下文切换：最后，操作系统会执行一条特殊的指令来实现上下文切换。这条指令会将CPU的状态从当前线程切换到根线程，从而开始执行根线程。
